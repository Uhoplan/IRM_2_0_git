<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="1080" version="1.2" width="1920" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:parameter behavior="optional" defaultvalue="AGENT.DISPLAYS.NewView.IRM2_2_0.main_irm2_0" name="target" valuetype="display"/>
  <atv:parameter behavior="optional" defaultvalue="AGENT.DISPLAYS.NewView.Auth.Authorization" name="auth" valuetype="display"/>
  <atv:gridconfig enabled="true" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="false" height="10" width="10"/>
 </metadata>
 <g atv:insensitive="true" atv:refpx="0" atv:refpy="0" id="id_2">
  <rect atv:refpx="960" atv:refpy="540" fill="#1f1f1f" height="1080.00" id="id_3" width="1920.00" x="0" y="0"/>
 </g>
 <text atv:refpx="863.591" atv:refpy="560" fill="#ffffff" font-family="Arial" font-size="72" id="id_1" x="834.5" y="564.5">Loading...</text>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[console.log(parent.document.location)
var sessions;
var currentSession;

var currentTime = new Date().getTime();

var startT = currentTime - 172800000;
var endT = currentTime;

var filter = {
	type: ["v:1"],
	address: ["g:AGENT.OBJECTS.Auth.sessions"],
	timestamp: ["n:>=" + startT + "<" + endT]
}
webMI.data.queryFilter(filter, function(e) {
	//sessions = e.result;
	
	//temp
	storedData = atob(localStorage.getItem("session")).split("-");
	currentSession = {
		session: storedData[0],
		timestamp: storedData[1]
	};
	//sessions = e.result.filter(function(session) {
	//
	//	return (new Date().getTime() - session.servertimestamp) < 172800000
	//})
	sessions = e.result;
	if (sessions.length > 0) {
		var some = sessions.some(function(session) {
			sessionData = JSON.parse(session.value)
			if (sessionData.timestamp == currentSession.timestamp && sessionData.session == currentSession.session) {
				webMI.data.login(sessionData.username, sessionData.password, function(e) {
					if (e[""].hasOwnProperty("username") && e[""].username){ 
						webMI.display.openDisplay(webMI.query["target"])
						
						return sessionData.timestamp == currentSession.timestamp && sessionData.session == currentSession.session
					}
				})
			} //else webMI.display.openDisplay(webMI.query["auth"])
		})
		if (!some) webMI.display.openDisplay(webMI.query["auth"])
	} else webMI.display.openDisplay(webMI.query["auth"])
})
]]></script>
</svg>
